<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>GADR Demo</title>
	<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
	 crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>

	<link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
	<style type="text/css">
		body {
			font: 10pt sans;
		}

		#adr-graph {
			width: 500px;
			height: 500px;
		}
	</style>
	<script type="text/javascript">
		function addRepo() {
			$('#repos').append('<br><input type="text" name="owner[]" value=""> <input type="text" name="repo[]" value="">');
		}
		function addGadrRepo() {
			$('#gadr-repos').append('<br><input type="text" name="gadr-owner[]" placeholder="adr"> <input type="text" name="gadr-repo[]" placeholder="adr-java">');
		}

	</script>
</head>

<body>
	<p>GADR Repository</p>
	<form id="gadr-repos">
		<input type="text" name="gadr-owner[]" placeholder="adr" value="adr">
		<input type="text" name="gadr-repo[]" placeholder="adr-java" value="gadr-java">
	</form>
	<br>
	<button onclick="addGadrRepo()">Add</button>
	<p>MADR Repositories</p>
	<form id="repos">
		<input type="text" name="owner[]" value="JabRef">
		<input type="text" name="repo[]" value="jabref">
		<br>
		<input type="text" name="owner[]" value="eclipse">
		<input type="text" name="repo[]" value="winery">
		<br>
		<input type="text" name="owner[]" value="snisnisniksonah">
		<input type="text" name="repo[]" value="gadr-demo">
	</form>


	<br>
	<button onclick="addRepo()">Add</button>
	<br>
	<button type="button" id="doit">Submit</button>
	<p>Doubleclick node to view XADR</p>
	<div id="adr-graph" hidden="hidden"></div>
	<pre id="file-content"></pre>


	<script type="text/javascript">

		/* 
		winery: https://github.com/eclipse/winery/tree/master/docs/adr
		jabref: https://github.com/JabRef/jabref/tree/master/docs/adr
		gadr-demo: https://github.com/snisnisniksonah/gadr-demo/tree/master/docs/adr
		* get directory listing : 
			curl -H "Accept: application/vnd.github.v3+json" https://raw.githubusercontent.com/adr/madr/master/docs/adr
	
		* get raw md (url from listing):
			curl -H "Accept: application/vnd.github.v3.raw+json" <url>
			e.g.:
			curl -H "Accept: application/vnd.github.v3.raw+json" https://raw.githubusercontent.com/adr/madr/master/docs/adr/0011-use-asterisk-as-list-marker.md
		*/

		function readUrl(e) {
			var adrs = [];
			var gadrs = [];

			function getAdrTitle(lines) {
				var titlePattern = new RegExp('^#\\s');
				var result = "";
				if (lines[0] && titlePattern.test(lines[0])) {
					result = lines[0].substring(2);
				}
				return result;
			}

			function getAdrLinks(repoid, lines) {
				var adrLinks = [];
				var linkStartPattern = new RegExp('^## Links');
				var linkPattern = new RegExp('^\\* (\\w+) \\[.*\\]\\((\\d+)-.*\\)')
				var gadrPattern = new RegExp('^\\* (GADR): .*')
				var size = lines.length;
				var banana = false;
				var i = 0;
				while (!banana && i != size) {
					banana = linkStartPattern.test(lines[i]);
					i++;
				}
				if (i != size) {
					var linkLines = lines.slice(i);
					for (var j = 0; j < linkLines.length; j++) {
						var match = linkPattern.exec(linkLines[j])
						var gadrmatch = gadrPattern.exec(linkLines[j])
						if (match) {
							var link = {
								relation: match[1],
								target: repoid + '.' + parseInt(match[2], 10)
							};
							adrLinks.push(link)
						}
						if (gadrmatch) {
							var link = {
								gadr: gadrmatch[1]
							};
							adrLinks.push(link)
						}
					}
				}
				return adrLinks;
			}

			function getAdrId(url, type) {
				var idPattern = new RegExp('.*/(\\d+)-.*md$');
				var match = idPattern.exec(url);
				if (type == 'adr') {
					return match && match[1] && parseInt(match[1], 10) || 0;
				} else if (type == 'gadr') {
					return url;
				} else {
					console.log('sad bear');
					return -1;
				}
			}

			var gadrRootUrlCollection = document.forms.gadr - repos;
			var gadrRootUrlOwner = document.getElementById("gadr-repos").elements["gadr-owner[]"];
			var gadrRootUrlRepo = document.getElementById("gadr-repos").elements["gadr-repo[]"];
			var gadrRootUrl = [];
			var adrRootUrlCollection = document.forms.repos;
			var adrRootUrlOwner = document.getElementById("repos").elements["owner[]"];
			var adrRootUrlRepo = document.getElementById("repos").elements["repo[]"];
			var adrRootUrl = [];
			var adjustedNumberOfRepos = adrRootUrlCollection.length / 2;
			for (var i = 0; i < adjustedNumberOfRepos; i++) {
				adrRootUrl.push({
					url: 'https://api.github.com/repos/' + adrRootUrlOwner[i].value + '/' + adrRootUrlRepo[i].value + '/contents/docs/adr',
					type: 'adr'
				}
				)
			}
			var adjustedNumberOfGadrRepos = gadrRootUrlCollection.length / 2;
			for (var j = 0; j < adjustedNumberOfGadrRepos; j++) {
				gadrRootUrl.push({
					url: 'https://api.github.com/repos/' + gadrRootUrlOwner[j].value + '/' + gadrRootUrlRepo[j].value + '/contents',
					type: 'gadr'
				}
				)
			}
			var adrBodyLocations = [];
			var gadrBodyLocations = [];

			function renderGraph() {
				var numberOfGADRRepos = 0;
				var numberOfADRRepos = 0;
				for (var m = 0; m < adrRootUrl.length; m++) {
					if (adrRootUrl[m].type == 'adr') {
						numberOfADRRepos++;
					} else if (adrRootUrl[m].type == 'gadr') {
						numberOfGADRRepos++;
						var GadrRepoId = m;
					}
				}

				adrs.sort(function (a, b) {
					return a.repoid - b.repoid;
				});
				var nodeData = [];
				var edgeData = [];
				var xoffset = 400;
				var yoffset = 0;
				var numberOfRepos = adrRootUrl.length;
				var eggplant = 0;
				var getRepoID = false;
				var regex = RegExp('snisnisniksonah');
				var demoRepo = false;

				for (var l = 0; l < numberOfRepos; l++) {
					var yoffset = 0;
					var isGadrRepo = false;
					var yoffsetmax = 0;
					var containsGadr = false;
					for (var i = 0; i < adrs.length; i++) {
						var adr = adrs[i];
						var belongsToGadr = false;
						if (adr.repoid == eggplant) {
							demoRepo = demoRepo || regex.test(adr.url);
							isGadrRepo = isGadrRepo || (adr.type == 'gadr');

							for (var k = 0; k < adr.links.length; k++) {
								var link = adr.links[k];
								var edge = {
									from: adr.id,
									to: link.target,
									label: link.relation
								};
								if (typeof link.gadr !== 'undefined') {
									var edge = {
										from: adr.id,
										to: String(GadrRepoId + '.https://raw.githubusercontent.com/adr/gadr-java/master/gadr-java--build-tool.md'),
										label: ' '
									};
									belongsToGadr = true;
									containsGadr = true;
								}
								edgeData.push(edge);

							}
							if (belongsToGadr) {
								var node = {
									id: adr.id,
									label: adr.title,
									group: String(adr.repoid),
									shape: 'square',
									url: adr.url,
									x: (isGadrRepo ? 100 : xoffset),
									y: 0,
									fixed: true
								};
								yoffset += 100;
								nodeData.push(node);
							} else if (containsGadr) {
								var node = {
									id: adr.id,
									label: adr.title,
									group: String(adr.repoid),
									shape: 'square',
									url: adr.url,
									x: (isGadrRepo ? 200 : xoffset),
									y: (isGadrRepo ? 0 : yoffset),
									fixed: true
								};
								yoffset += 100;
								nodeData.push(node);
							} else if (demoRepo) {
								var node = {
									id: adr.id,
									label: adr.title,
									group: String(adr.repoid),
									shape: 'square',
									url: adr.url,
									x: (isGadrRepo ? 200 : xoffset),
									y: (isGadrRepo ? 0 : yoffset + 2800),
									fixed: true
								};
								yoffset += 100;
								nodeData.push(node);
							} else {
								var node = {
									id: adr.id,
									label: adr.title,
									group: String(adr.repoid),
									shape: 'square',
									url: adr.url,
									x: (isGadrRepo ? 200 : xoffset),
									y: (isGadrRepo ? 0 : yoffset + 100),
									fixed: true
								};
								yoffset += 100;
								nodeData.push(node);
							}


						}
					}

					if (!isGadrRepo) {
						xoffset += 200;
					}
					eggplant++;
					if (yoffset > yoffsetmax) {
						yoffsetmax = yoffset + 100;
					}

				}


				//var nodes = new vis.DataSet(nodeData.sort(SortByID));
				var nodes = new vis.DataSet(nodeData);
				var edges = new vis.DataSet(edgeData);
				var container = document.getElementById('adr-graph');
				var data = {
					nodes: nodes,
					edges: edges
				};
				var options = {
					groups: {
						"0": { color: 'rgb(230, 46, 0)', },
						"1": { color: 'rgb(0, 153, 255)' },
						"2": { color: 'rgb(0, 204, 102)' },
						"3": { color: 'rgb(255, 153, 0)' },
						"4": { color: 'rgb(255, 102, 204)' }
					}
				};
				var network = new vis.Network(container, data, options);
				$("#adr-graph").show();

				network.on("doubleClick", function (params) {
					if (params.nodes.length === 1) {
						var node = nodes.get(params.nodes[0]);
						window.open(node.url, '_blank');
					}
				});
			}

			function displayContents(size) {
				return function () {
					if (size == adrs.length + gadrs.length) {
						renderGraph();
					}
				};
			}

			function compare(a, b) {
				if (a.repoid < b.repoid)
					return -1;
				if (a.repoid > b.repoid)
					return 1;
				return 0;
			}

			function getSingleAdr(myUrl, repoid, linkUrl, type, callback) {
				var handleResponse = function (data) {
					var result = {};
					var dataLines = data.split('\n');
					result.url = linkUrl;
					result.id = repoid + '.' + getAdrId(myUrl, type);
					result.repoid = repoid;
					result.title = getAdrTitle(dataLines);
					result.links = getAdrLinks(repoid, dataLines);
					result.type = type;
					if (type == 'adr') {
						adrs.push(result);
					} else if (type == 'gadr') {
						gadrs.push(result);
					}
				};
				$.ajax({
					url: myUrl,
					type: 'get',
					dataType: 'text',
					success: handleResponse
				}).always(callback);
			}

			function loadDocsContent(repos) {
				return function () {
					if (repos == gadrBodyLocations.length + adrBodyLocations.length) {
						var expected = 0;
						for (var i = 0; i < adrBodyLocations.length; i++) {
							expected += adrBodyLocations[i].length;
						}
						for (var n = 0; n < gadrBodyLocations.length; n++) {
							expected += gadrBodyLocations[n].length;
						}
						var callback = displayContents(expected);
						for (var j = 0; j < adrBodyLocations.length; j++) {
							var reposadrs = adrBodyLocations[j];
							for (var k = 0; k < reposadrs.length; k++) {
								getSingleAdr(reposadrs[k].url, j, reposadrs[k].linkTarget, 'adr', callback);
							}
						}
						for (var m = 0; m < gadrBodyLocations.length; m++) {
							var reposgadrs = gadrBodyLocations[m];
							for (var l = 0; l < reposgadrs.length; l++) {
								getSingleAdr(reposgadrs[l].url, m, reposgadrs[l].linkTarget, 'gadr', callback);
							}
						}
					}
				};
			}

			function loadAdrList() {
				var idPattern = new RegExp('.*/(\\d+)-.*');
				var GADRPattern = new RegExp('.*/master/(gadr-java).*');
				function handleResponse(destination, pattern) {
					return function (data) {
						var result = [];
						if (data) {
							for (var j = 0; j < data.length; j++) {
								if (data[j] && data[j].download_url && pattern.test(data[j].download_url)) {
									result.push({ url: data[j].download_url, linkTarget: data[j].html_url });
								}
							}
						}
						destination.push(result);
					};
				};
				var handleError = function () { console.log("sad panda"); };
				var doneHandler = loadDocsContent(adrRootUrl.length + gadrRootUrl.length);
				for (i = 0; i < gadrRootUrl.length; i++) {
					$.ajax({
						url: gadrRootUrl[i].url,
						type: 'get',
						contentType: 'application/vnd.github.VERSION.raw+json; charset=UTF-8',
						dataType: 'json',
						success: handleResponse(gadrBodyLocations, GADRPattern)
					}).done(doneHandler).fail(handleError);
				}
				for (j = 0; j < adrRootUrl.length; j++) {
					$.ajax({
						url: adrRootUrl[j].url,
						type: 'get',
						contentType: 'application/vnd.github.VERSION.raw+json; charset=UTF-8',
						dataType: 'json',
						success: handleResponse(adrBodyLocations, idPattern)
					}).done(doneHandler).fail(handleError);
				}
			}

			loadAdrList();

		}



		document.getElementById('doit')
			.addEventListener('click', readUrl, false);

	</script>
</body>

</html>