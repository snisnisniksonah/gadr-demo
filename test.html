<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>GADR Demo</title>
	<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
	
	<link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
	<style type="text/css">
    body {
      font: 10pt sans;
    }
    #adr-graph {
      width: 1000px;
      height: 1000px;
    }
  </style>
</head>

<body>
	<p>GADR Repository</p>
	<input type="text" name="owner1" id="owner1" placeholder="adr" value="adr">
	<input type="text" name="repo1" id="repo1" placeholder="adr-java" value="adr-java">
	<p>MADR Repositories</p>
	<input type="text" name="owner2" id="owner2" placeholder="JabRef" value="JabRef">
	<input type="text" name="repo2" id="repo2" placeholder="jabref" value="jabref">
	<br>
	<input type="text" name="owner3" id="owner3" placeholder="eclipse" value="eclipse">
	<input type="text" name="repo3" id="repo3" placeholder="winery" value="winery">
	<br>
	<input type="text" name="owner4" id="owner4" placeholder="snisnisniksonah" value="snisnisniksonah">
	<input type="text" name="repo4" id="repo4" placeholder="gadr-demo" value="gadr-demo">
	<br>
	<br>
	<button type="button" id="doit">Submit</button>
	<p>Doubleclick node to view XADR</p>
	<div id="adr-graph" hidden="hidden"></div>
	<pre id="file-content"></pre>
	

	<script type="text/javascript">
	
	/* 
	winery: https://github.com/eclipse/winery/tree/master/docs/adr
	jabref: https://github.com/JabRef/jabref/tree/master/docs/adr
	gadr-demo: https://github.com/snisnisniksonah/gadr-demo/tree/master/docs/adr
	* get directory listing : 
		curl -H "Accept: application/vnd.github.v3+json" https://raw.githubusercontent.com/adr/madr/master/docs/adr

	* get raw md (url from listing):
		curl -H "Accept: application/vnd.github.v3.raw+json" <url>
		e.g.:
		curl -H "Accept: application/vnd.github.v3.raw+json" https://raw.githubusercontent.com/adr/madr/master/docs/adr/0011-use-asterisk-as-list-marker.md
	*/
	
	
	
		function readUrl(e) {
			var adrs = [];

			function getAdrTitle(lines) {
				var titlePattern = new RegExp('^#\\s');
				var result = "";
				if (lines[0] && titlePattern.test(lines[0])) {
					result = lines[0].substring(2);
				}
				return result;
			}
			
			function getAdrLinks(repoid, lines) {
				var result = [];
				var linkStartPattern = new RegExp('^## Links');
				var linkPattern = new RegExp ('^\\* (\\w+) \\[.*\\]\\((\\d+)-.*\\)')
				var gadrPattern = new RegExp ('^\\* (GADR): <https://github.com/adr/gadr-java/blob/master/(gadr-java--build-tool)\\.md>')
				var size = lines.length;
				var banana = false;
				var i = 0;
				while (!banana && i != size) {
					banana = linkStartPattern.test(lines[i]);
					i++;
				}
				if (i != size) {
					var linkLines = lines.slice(i);
					for (var j = 0 ; j < linkLines.length ; j++) {
						var match = linkPattern.exec(linkLines[j])
						var gadrmatch = gadrPattern.exec(linkLines[j])
						if (match) {
							var link = {
								relation: match[1],
								target: repoid + '.' + parseInt(match[2], 10)
							};
							result.push(link)
						}
						if (gadrmatch) {
							var link = {
								gadr: gadrmatch[1]
							};	
							result.push(link)
						}
					}
				}
				return result;
			}
			
			function getAdrId(url) {
				var idPattern = new RegExp('.*/(\\d+)-.*md$');
				var match = idPattern.exec(url);
				return match && match[1] && parseInt(match[1], 10) || 0;
			}
			//TODO: RootUrl -> cleaned/mapped Input from Input field
			//https://github.com/adr/madr/tree/master/docs/adr
			//var adrRootUrl = 'https://api.github.com/repos/adr/madr/contents/docs/adr';
			//var cleanInput = new RegExp ('https://github.com/(.*)/(.*)/.*/.*/(.*)/(.*)')
			var owner1 = document.getElementById('owner1').value
			var repo1 = document.getElementById('repo1').value
			
			var owner2 = document.getElementById('owner2').value
			var repo2 = document.getElementById('repo2').value
			var owner3 = document.getElementById('owner3').value
			var repo3 = document.getElementById('repo3').value
			var owner4 = document.getElementById('owner4').value
			var repo4 = document.getElementById('repo4').value			
			
			var gadrRootUrl = 'https://api.github.com/repos/'+ owner1 + '/' + repo1 + '/contents/docs/adr'
			var adrRootUrl = [];
			for ( var z=2; z<=4; z++) {
				if (eval("owner"+z) != "" && eval("repo"+z) != ""){
				adrRootUrl.push('https://api.github.com/repos/'+ eval("owner"+z) + '/' + eval("repo"+z) + '/contents/docs/adr')
				}
			}	
			var bodyLocations = [];
			
			function displayText () {
				var element = document.getElementById('file-content');
				var displayText = "";
				for (var k=0; k< adrs.length; k++) {
					var adr = adrs[k];
					displayText += 'Id: ' + adr.id + '\n';
					displayText += 'Title: ' + adr.title + '\n';
					//this is not pretty, but it works
					if (adr.links.length > 0) {
						displayText += 'Links: \n'
						for (var i = 0; i < adr.links.length ; i++) {
							var link = adr.links[i];
							if (typeof link.target !== 'undefined') {
							displayText += link.target ;
							}
							if (typeof link.relation !== 'undefined') {
							displayText += link.relation +'\n';
							}							
							if (typeof link.gadr !== 'undefined') {
							displayText += link.gadr + '\n';
							}							
						}
					} else {
						displayText += "No links" + '\n';
					}
					displayText += '\n';
				}
				element.textContent = displayText;
			}
			
			function renderGraph() {
				var nodeData = [];
				var edgeData = [];
				var xoffset = 100;
				var yoffset = 100;
			
				for (var i = 0; i < adrs.length; i++) {
					var adr = adrs[i];
					if (i >= 1) { 
					var prev = adrs[i-1];
					var helper = adr.links.length;
					} else {
					var otherHelper = 0;
					}
					//var otherHelper = prev.links.length;
					
					var q = 0;	
					if (adr.links.length > 0) {												
						for (;q < helper; q++) {
							var node = {
								id: adr.id,
								label: adr.title,
								group: String(adr.id.split(".",1)),
								shape: 'square',				
								url: adr.url,
								x: xoffset + 100 * q,
								y: yoffset + 100 * i,
								fixed: true		
								};
						}						
						
					} else {									
						var node = {
							id: adr.id,
							label: adr.title,
							group: String(adr.id.split(".",1)),
							shape: 'square',				
							url: adr.url,
							x: xoffset,
							y: yoffset + 100*i,
							fixed: true						
						};
					}	
					
					nodeData.push(node);

					if (adr.links) {
						for (var k = 0; k < adr.links.length; k++) {
							var link = adr.links[k];
							var edge = {
								from: adr.id,
								to:	link.target,
								label: link.relation
							};
							if (typeof link.target === 'undefined' && typeof link.relation === 'undefined'){
								var edge ={
								from: adr.id,
								to: '4.0',
								label: 'result of'
								};
							}
							edgeData.push(edge);
						}
					}
				}
					var gadr = {
						id: '4.0',
						label: "Build Tool",
						group: '4',
						shape: 'square',				
						url: "https://raw.githubusercontent.com/adr/gadr-java/master/gadr-java--build-tool.md",
						x: -300,
						y: 1400,
						fixed: true						
					};
					
					nodeData.push(gadr);			
						
				//var nodes = new vis.DataSet(nodeData.sort(SortByID));
				var nodes = new vis.DataSet(nodeData);
				var edges = new vis.DataSet(edgeData);
				var container = document.getElementById('adr-graph');
				var data = {
					nodes: nodes,
					edges: edges
				};
				var options = {
					groups: {
						"0": {color: 'rgb(230, 46, 0)',},
						"1": {color: 'rgb(0, 153, 255)'},
						"2": {color: 'rgb(0, 204, 102)'},
						"3": {color: 'rgb(255, 153, 0)'},
						"4": {color: 'rgb(255, 102, 204)'}
					}
				};
				var network = new vis.Network(container, data, options);
				$( "#adr-graph" ).show();
				
				network.on("doubleClick", function (params) {
					if (params.nodes.length === 1) {
						var node = nodes.get(params.nodes[0]);
						window.open(node.url, '_blank');
					}
					});
			}
			
			function displayContents(size) {
				return function() {
					if (size == adrs.length ) {
						//displayText();
						renderGraph();
					}
				};
			}

			function getSingleAdr(myUrl, repoid, callback) {
				var handleResponse = function(data) {
					var result = {};
					var dataLines = data.split('\n');
					result.url = myUrl;
					result.id = repoid + '.' + getAdrId(myUrl);
					result.title = getAdrTitle(dataLines);
					result.links = getAdrLinks(repoid, dataLines);
					adrs.push(result);
				};
				$.ajax({
					url: myUrl,
					type: 'get',
					dataType: 'text',
					success: handleResponse
				}).always(callback);
			}
			
			function loadDocsContent (repos) {
				return function() {
					if (repos == bodyLocations.length ) {
						var expected = 0;
						for ( var n = 0; n < bodyLocations.length; n++) {
							expected += bodyLocations[n].length;
						}
						for ( var m = 0; m < bodyLocations.length; m++) {
							var reposadrs = bodyLocations[m];
							for (var l = 0; l < reposadrs.length; l++) {
								var callback = displayContents(expected);
								getSingleAdr(reposadrs[l], m, callback);
							}
						}
					}
				};
			}
			
			function loadAdrList () {
				var handleResponse = function(data) {
					var idPattern = new RegExp('.*/(\\d+)-.*');
					var result = [];
					if (data) {
						for ( var i = 0; i < data.length ; i++) {
							if (data[i] && data[i].download_url && idPattern.test(data[i].download_url)) {
								result.push(data[i].download_url);
							}
						}
					}
					bodyLocations.push(result);
				};
				var handleError = function() {console.log("sad panda");};
				var doneHandler = loadDocsContent (adrRootUrl.length);
				for (i=0; i < adrRootUrl.length; i++) {				
				$.ajax({
					url: adrRootUrl[i],
					type: 'get',
					contentType: 'application/vnd.github.v3.raw+json; charset=UTF-8',
					dataType: 'json',
					success: handleResponse
				}).done(doneHandler).fail(handleError);
				}
			
			}
			
			loadAdrList();
			
		}



		document.getElementById('doit')
			.addEventListener('click', readUrl, false);
	</script>
</body>

</html>
